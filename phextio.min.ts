// phext.ts
// this monstrosity of an implementation is basically Will's stream of consciousness
// if you want to refactor it for clarity, please submit a pr
// (c) 2023-2024 Will Bickford
// License: MIT
// see phext.ts for the source
// compressed with https://www.toptal.com/developers/javascript-minifier
function dgid(e){return document.getElementById(e)}var upstream="https://github.com/wbic16/phextio",raw="",phexts={};localStorage.raw&&localStorage.raw.length>0?raw=localStorage.raw:(raw="<html>\n<head>\n<title>Reference Phext Document</title>\n</head>\n<body>\n\nYou are currently at 1.1.1/1.1.1/1.1.1.\nWe are aware of the following nodes:\n\n<a href='phext://1.1.1/1.1.1/1.1.2'>Scroll #2</a>\n<a href='phext://1.1.1/1.1.1/1.1.3'>Scroll #3</a>\n<a href='phext://1.1.1/1.1.1/1.1.4'>Scroll #4</a>\n\n</body>\n</html>\x17Scroll #2\n---------\nThis happens to be a MarkDown file.\n\n\x17Scroll #3: Just a line of text.\x17<html>\n<head>\n<title>Scroll #4</title>\n</head>\n<body>\n<a href='phext://1.1.1/1.1.1/1.1.1'>Return Home</a>\n\n<h1>Scroll #4</h1>\n</body>\n</html>",localStorage.raw=raw);var phextMode="n";const LINE_BREAK="\n",SCROLL_BREAK="\x17",SECTION_BREAK="\x18",CHAPTER_BREAK="\x19",BOOK_BREAK="\x1a",VOLUME_BREAK="\x1c",COLLECTION_BREAK="\x1d",SERIES_BREAK="\x1e",SHELF_BREAK="\x1f",LIBRARY_BREAK="\x01",F1_KEY=112,F2_KEY=113,F3_KEY=114,F4_KEY=115,F5_KEY=116,F6_KEY=117,F7_KEY=118,F8_KEY=119,F9_KEY=120,F10_KEY=121,F11_KEY=122,F12_KEY=123;var enterKey="\n",replacementDescription="ENTER",priorButton=!1,DimensionBreaks=["\x17","\x18","\x19","\x1a","\x1c","\x1d","\x1e","\x1f","\x01"];function defaultCoordinates(){var e=[];return e["\n"]=1,e["\x17"]=1,e["\x18"]=1,e["\x19"]=1,e["\x1a"]=1,e["\x1c"]=1,e["\x1d"]=1,e["\x1e"]=1,e["\x1f"]=1,e["\x01"]=1,e}var gl=!1,ns=!1,ta=!1,cs=!1,ls=!1,cx=!1,cy=!1,cz=!1,wr=!1,st=!1,lk=!1,cp=!1,ha=!1,sa=!1,vr=!1,qr=!1,lt=!1,sd=!1,se=!1,lts=!1,qrui=!1,qrd=!1,qrl=!1,qt=!1,nodes=[],qurl="",phextCoordinate="1.1.1/1.1.1/1.1.1";function loadVars(){gl||(gl=dgid("goal")),ns||(ns=dgid("nodes")),ta||(ta=dgid("scroll")),cs||(cs=dgid("coords")),ls||(ls=dgid("subspace")),cx||(cx=dgid("coordsX")),cy||(cy=dgid("coordsY")),cz||(cz=dgid("coordsZ")),wr||(wr=dgid("whiterabbit")),st||(st=dgid("subspaceTitle")),cp||(cp=dgid("coordinatePlate")),ha||(ha=dgid("helparea")),sa||(sa=dgid("subspaceArea")),lt||(lt=dgid("linkerText")),sd||(sd=dgid("seed")),se||(se=dgid("seeds")),lts||(lts=dgid("linkerStatus")),qrui||(qrui=dgid("qrcode")),qrl||(qrl=dgid("qrlabel")),qt||(qt=dgid("quest")),localStorage.seed&&(sd.value=localStorage.seed)}function updateCoordinate(){phextCoordinate=cx.value+"/"+cy.value+"/"+cz.value}var coords=defaultCoordinates(),target=defaultCoordinates(),scrollFound=!1;function loadPhext(){raw=ls.value,coords=defaultCoordinates();var e=cz.value.split("."),o=cy.value.split("."),t=cx.value.split(".");e.length>=1&&(target["\x01"]=e[0]),e.length>=2&&(target["\x1f"]=e[1]),e.length>=3&&(target["\x1e"]=e[2]),o.length>=1&&(target["\x1d"]=o[0]),o.length>=2&&(target["\x1c"]=o[1]),o.length>=3&&(target["\x1a"]=o[2]),t.length>=1&&(target["\x19"]=t[0]),t.length>=2&&(target["\x18"]=t[1]),t.length>=3&&(target["\x17"]=t[2]),scrollFound=!1,qt.innerHTML="",nodes=[],totalScrolls=1,raw.split("\x01").forEach(e=>processLibrary(e)),scrollFound||(ta.value=""),qt.innerHTML=nodes.join("\n")}function dimensionBreak(e){"\x01"==e&&(++coords["\x01"],coords["\x1f"]=1,coords["\x1e"]=1,coords["\x1d"]=1,coords["\x1c"]=1,coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1f"==e&&(++coords["\x1f"],coords["\x1e"]=1,coords["\x1d"]=1,coords["\x1c"]=1,coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1e"==e&&(++coords["\x1e"],coords["\x1d"]=1,coords["\x1c"]=1,coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1d"==e&&(++coords["\x1d"],coords["\x1c"]=1,coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1c"==e&&(++coords["\x1c"],coords["\x1a"]=1,coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x1a"==e&&(++coords["\x1a"],coords["\x19"]=1,coords["\x18"]=1,coords["\x17"]=1),"\x19"==e&&(++coords["\x19"],coords["\x18"]=1,coords["\x17"]=1),"\x18"==e&&(++coords["\x18"],coords["\x17"]=1),"\x17"==e&&++coords["\x17"]}function processLibrary(e){e.split("\x1f").forEach(e=>processShelf(e)),dimensionBreak("\x01")}function processShelf(e){e.split("\x1e").forEach(e=>processSeries(e)),dimensionBreak("\x1f")}function processSeries(e){e.split("\x1d").forEach(e=>processCollection(e)),dimensionBreak("\x1e")}function processCollection(e){e.split("\x1c").forEach(e=>processVolume(e)),dimensionBreak("\x1d")}function processVolume(e){e.split("\x1a").forEach(e=>processBook(e)),dimensionBreak("\x1c")}function processBook(e){e.split("\x19").forEach(e=>processChapter(e)),dimensionBreak("\x1a")}function processChapter(e){e.split("\x18").forEach(e=>processSection(e)),dimensionBreak("\x19")}function processSection(e){e.split("\x17").forEach(e=>processScroll(e)),dimensionBreak("\x18")}function coordinatesMatch(e,o){return e["\x17"]==o["\x17"]&&e["\x18"]==o["\x18"]&&e["\x19"]==o["\x19"]&&e["\x1a"]==o["\x1a"]&&e["\x1c"]==o["\x1c"]&&e["\x1d"]==o["\x1d"]&&e["\x1e"]==o["\x1e"]&&e["\x1f"]==o["\x1f"]&&e["\x01"]==o["\x01"]}function coordToString(e){var o,t=e["\x01"]+"."+e["\x1f"]+"."+e["\x1e"];return t+"/"+(e["\x1d"]+"."+e["\x1c"]+"."+e["\x1a"])+"/"+(e["\x19"]+"."+e["\x18"]+".")+e["\x17"]}function coordinateHit(e){var o=e["\x01"]+"."+e["\x1f"]+"."+e["\x1e"],t=e["\x1d"]+"."+e["\x1c"]+"."+e["\x1a"],l=e["\x19"]+"."+e["\x18"]+"."+e["\x17"];return"<a href='"+getPhextUrl(l,t,o)+"'>@"+o+"/"+t+"/"+l+"</a>"}function drawNode(e,o){e["\x17"];var t=o;return o.length>250&&(t=o.substring(0,250),t+="..."),"<div class='node' onclick='loadNode("+coordToString(e)+");'>"+coordinateHit(e)+" <input type='button' onclick='editScroll("+e+");' value='Edit' /><br />"+t+"</div>"}var totalScrolls=1;function processScroll(e){if(coordinatesMatch(target,coords)){ta.value=e,scrollFound=!0;var o=e.split("\n").length;o<100?ta.rows=o:ta.rows=100}e.length>0&&(nodes[totalScrolls]=drawNode(coords,e),++totalScrolls),dimensionBreak("\x17")}function safeEncode(e){return!e||e.length<1?"":encodeURIComponent(e.replaceAll("'","%27"))}function updateQR(){qr||(qr=new QRCode(document.getElementById("qrcode"),{text:"https://phext.io/index.html",width:640,height:640}),qrui.style.background="#000"),qr.clear(),qr.makeCode(qurl)}var timeoutDelay=1e3;function getPhextUrl(e,o,t){return qurl="https://phext.io/index.html?seed="+safeEncode(sd.value)+"&cz="+safeEncode(t)+"&cy="+safeEncode(o)+"&cx="+safeEncode(e)+"&"+phextMode+"="+safeEncode(raw),lt.value=qurl,qrd&&clearTimeout(qrd),qrd=setTimeout(updateQR,timeoutDelay),lts.innerHTML="",qurl}function greypill(){gl.style.display="block",ns.style.display="block",wr.style.display="none",ta.style.display="none",cp.style.display="none",ha.style.display="none",sa.style.display="none",qrui.style.display="block",qrl.style.display="none",qt.style.display="none"}function redpill(e){phextMode="r",st.innerHTML="Follow the <a class='small' href='white-rabbit.html'>White Rabbit</a>.",gl.style.display="none",ns.style.display="none",wr.style.display="block",ta.style.display="block",cp.style.display="block",ha.style.display="block",sa.style.display="block",qrui.style.display="block",qrl.style.display="block",qt.style.display="block",updateCoordinate(),loadPhext(),getPhextUrl(cx.value,cy.value,cz.value),e&&saveContent()}function saveContent(){if(localStorage.raw=ls.value,sd.value&&0!=sd.value.trim().length||(sd.value="holiday"),!phexts[sd.value]){var e=document.createElement("option");e.value=sd.value,e.innerHTML=sd.value,e.selected=!0,se.appendChild(e)}phexts[sd.value]=ls.value,localStorage.seed=sd.value,localStorage.phexts=JSON.stringify(phexts)}function bluepill(){phextMode="b",gl.style.display="none",ns.style.display="none",wr.style.display="none",ta.style.display="none",cp.style.display="none",ha.style.display="none",sa.style.display="block",qrui.style.display="none",qrl.style.display="none",qt.style.display="none",ta.value=raw,ta.rows=raw.split("\n").length,st.innerHTML="Believe",ta.value=raw,dgid("linker").href=getPhextUrl(cx.value,cy.value,cz.value)+"#BluePill"}function whitepill(){window.open(upstream)}function copyUrl(){getPhextUrl(),saveContent(),navigator.clipboard.writeText(qurl),lts.innerHTML="URL copied!"}function startup(){dgid("pscrollbreak").value="\x17",dgid("psectionbreak").value="\x18",dgid("pchapterbreak").value="\x19",dgid("pbookbreak").value="\x1a",dgid("pvolumebreak").value="\x1c",dgid("pcollectionbreak").value="\x1d",dgid("pseriesbreak").value="\x1e",dgid("pshelfbreak").value="\x1f",dgid("plibrarybreak").value="\x01",loadVars();var e=Object.fromEntries(new URLSearchParams(window.location.search).entries());e.cz&&(cz.value=e.cz),e.cy&&(cy.value=e.cy),e.cx&&(cx.value=e.cx),e.seed&&(localStorage.seed=e.seed,sd.value=e.seed),localStorage.phexts&&Object.keys(phexts=JSON.parse(localStorage.phexts)).forEach(e=>{var o=document.createElement("option");o.value=e,o.innerHTML=e,e==sd.value&&(o.selected=!0),se.appendChild(o)}),phexts&&phexts[e.seed]&&(localStorage.raw=localStorage.phexts[e.seed]),localStorage.raw&&(raw=localStorage.raw),ls.value=raw,e.r&&(raw=e.r.replaceAll("%27","'"),ls.value=raw,redpill(!1)),e.b&&(raw=e.b.replaceAll("%27","'"),ls.value=raw,bluepill())}function setEnterType(e,o,t){enterKey=t;var l=dgid("CB"+e+"_"+o);l&&(priorButton&&(priorButton.style.borderStyle="",priorButton.style.backgroundColor=""),l.style.borderStyle="inset",l.style.backgroundColor="orange",replacementDescription="&lt;"+l.value+"&gt;",priorButton=l)}function phextMods(e,o){if(!remapFunctionKeys[e])return;for(var t=F1_KEY;t<=121;++t)if(o.keyCode==t){o.preventDefault();var l=dgid("CB"+e+"_"+(o.keyCode-F1_KEY+2));l&&l.click();continue}if("Enter"!==o.key)return;o.preventDefault();var r=document.activeElement;let s=r.selectionStart,n=r.value.substring(0,s),a=r.value.substring(r.selectionEnd,r.value.length),_="\n"==enterKey?enterKey:enterKey+"\n";r.value=n+_+a,r.selectionStart=r.selectionEnd=s+1,r.focus()}var remapFunctionKeys=[];function toggle(e){var o=dgid("disabler"+e);if(!o)return;let t="Disable"===o.value;o.value=t?"Enable":"Disable",remapFunctionKeys[e]=t}function chooseSeed(e){sd.value=e.value,ls.value=phexts[e.value]}function removeSeed(){phexts[sd.value]&&(delete phexts[sd.value],Object.keys(se.options).forEach(e=>{se.options[e]&&se.options[e].value==sd.value&&se.options.remove(e)}),sd.value=se.options[se.selectedIndex].value,localStorage.seed=sd.value,localStorage.phexts=JSON.stringify(phexts))}remapFunctionKeys[1]=!0,remapFunctionKeys[2]=!0;