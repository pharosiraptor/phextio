<!DOCTYPE html>
<html>
<head>
<title>phext.io | White Rabbit</title>
<link rel="StyleSheet" href="phext.css?rev=1" />
<style type="text/css">
#rabbit {
  font-family: monospace;
  padding-top: 20px;
}
body {
  font-size: 1.6em;
  margin-left: 40px;
}
#breadcrumbs {
  position: absolute;
  top: 0px;
  left: 0px;
}
#banner {
  height: 40px;
  position: absolute;
  top: 0px;
  left: 0px;
  width: 720px;
  border-bottom: 2px solid white;
}
#score {
  position: absolute;
  top: 0px;
  right: 0px;
  width: 150px;
  height: 40px;
  background: #223243;
}
#coins {
  position: absolute;
  top: 4px;
  left: 20px;
  color: yellow;
  font-family: monospace;
  font-weight: bold;
  font-size: 0.9em;
}
#questbox {
  width: 720px;
  height: 900px;
}

#title {
  text-align: center;
  width: 100%;
  font-size: 3em;
}
#screen {
  width: 98%;
  height: 98%;
  margin-top: 20px; 
  padding-top: 40px;
  margin: 0 auto;
  position: relative;
  user-select: none;
}
#gameOver {
  position: absolute;
  top: 10%;
  left: 35%;
  width: 30%;
  height: 70%;
  font-size: 2.2em;
  border: 3px solid white;
  border-radius: 4px;
  z-index: 2000;
  background-color: black;
  display: none;
  text-align: center;
}
#player {
  position: absolute;
  top: 500px;
  left: 600px;
  z-index: 1000;
  border-radius: 40px;
  border: 3px solid white;
  background-color: coral;
  width: 40px;
  height: 60px;
  transition: 0.1s linear;
  filter: drop-shadow(0 0 1rem white);
}
#enemy {
  position: absolute;
  top: 400px;
  left: 400px;
  z-index: 999;
  border-radius: 80px;
  border: 3px solid black;
  background-color: black;
  width: 80px;
  height: 80px;
  transition: 0.1s linear;
  filter: drop-shadow(0 0 0.5rem red);
}
#board {
  width: 90%;
  height: 90%;
  border: 10px solid #42fe42;
  border-radius: 10px;
  margin: 0 auto;
  padding-left: 30px;
  position: relative;
  background: black;
  clear: both;
}
#board .floor,
#board .wall,
#board .wall2,
#board #fox {
  margin: 0%;
  padding: 0%;
  float: left;
  border-radius: 10px;
}
#board #fox {
  border: 1px solid gold;
  background-color: blue;  
}
#board .floor {
  width: 1.55%;
  height: 6.1%;
}
#board div.wall {
  background-color: #424595;
  width: 1.55%;
  height: 6.1%;
}
#board div.wall2 {
  background-color: #424242;
  width: 1.55%;
  height: 6.1%;
}
div.wall .inner,
div.wall2 .inner {
  border: 1px solid white;
}
div.wall .inner,
div.wall2 .inner,
div.floor .inner {
  height: 100%;
  border-radius: 10px;
  z-index: 3;
}
#board div.wall .inner:hover,
#board div.wall2 .inner:hover {
  border: 1px solid yellow;
}
#top {
  position: relative;
  left: 10%;
  background-color: black;
  width: 90%;
}
#scoreLabel, #gamescore,
#livesLabel, #gamelives,
#soundLabel, #soundControl {
  float: left;
}
#soundControl {
  border: 3px solid white;
  border-radius: 6px;
  padding: 4px;
  padding-left: 25px;
  padding-right: 25px;
  position: relative;
  top: -6px;
  margin-left: 10px;
}
#soundControl:hover {
  background-color: white;
  color: black;
  cursor: pointer;
}
#timerLabel, #timer {
  float: right;
}
#gamescore {
  padding-left: 20px;
  padding-right: 200px;
  width: 100px;
}
#gamelives {
  padding-left: 20px;
  padding-right: 400px;
}
#timer {
  padding-left: 20px;
  padding-right: 200px;
  width: 200px;
}
#bottom {
  position: relative;
  top: 0px;
  height: 60px;
  width: 90%;
  margin-left: 5%;
}
#prev {
  position: absolute;
  bottom: 0px;
  left: 10px;
  border: 4px solid white;
  padding: 10px;
  padding-left: 20px;
  padding-right: 20px;
}
#next {
  position: absolute;
  bottom: 0px;
  right: 10px;
  border: 4px solid white;
  padding: 10px;
  padding-left: 20px;
  padding-right: 20px;
}
#select {
  position: absolute;
  bottom: 0px;
  left: 45%;
  border: 4px solid white;
  padding: 10px;
  padding-left: 20px;
  padding-right: 20px;
}
#prev:hover,
#next:hover,
#select:hover {
  background-color: grey;
  cursor: pointer;
}
</style>
<script type="text/JavaScript">
// -----------------------------------------------------------------------------------------------------------
// @fn dgid
//
// @param id  element identifier
// -----------------------------------------------------------------------------------------------------------
function dgid(id) {
  return document.getElementById(id);
}

var TILES_MAX_WIDTH = 64;
var TILES_MAX_HEIGHT = 16;
var gameLog = '';

var re = false; // response
var co = false; // coins
var ss = false; // spheres
var qb = false; // questbox
var rb = false; // rabbit
var attempts = 0;
var nuggets = 0;
var spheres = 0;

if (localStorage.attempts) {
  attempts = localStorage.attempts;
}
if (localStorage.nuggets) {
  nuggets = localStorage.nuggets;
}
if (localStorage.spheres) {
  spheres = localStorage.spheres;
}

// -----------------------------------------------------------------------------------------------------------
// @fn loadVars
//
// loads DOM elements. also see `loadVarsForNovaFox`
// -----------------------------------------------------------------------------------------------------------
function loadVars() {
  if (!re) {
    re = dgid("response");
  }
  if (!co) {
    co = dgid("coins");
  }
  if (!ss) {
    ss = dgid("spheres");
  }
  if (!qb) {
    qb = dgid("questbox");
  }
  if (!rb) {
    rb = dgid("rabbit");
  }
}

var go = false; // gameOver
var sc = false; // soundControl
var gt = false;  // game timer
var gs = false;  // game score
var player = false;
var enemy = false;

// -----------------------------------------------------------------------------------------------------------
// @fn loadVarsForNovaFox
//
// loads element handles specifically for nova fox. also see `loadVars`
// -----------------------------------------------------------------------------------------------------------
function loadVarsForNovaFox() {
  if (!go ) {
    go = dgid("gameOver");
  }
  if (!sc) {
    sc = dgid("soundControl");
  }
  if (!gt) {
    gt = dgid("timer");
  }
  if (!gs) {
    gs = dgid("gamescore");
  }
  if (!player) {
    player = dgid("player");
  }
  if (!enemy) {
    enemy = dgid("enemy");
  }
}

// -----------------------------------------------------------------------------------------------------------
// @fn begin
//
// startup routine for the white rabbit module. provides access to nova fox and the chapters visualizer.
// -----------------------------------------------------------------------------------------------------------
function begin(token) {
  loadVars();
  if (token == "cortical") {
    re.innerHTML = "Incorrect, a Cortical is someone who writes source code for the exocortex. Try again.";
  }
  if (token == "lurker") {
    re.innerHTML = "Incorrect, a Lurker is someone who just doesn't understand Phext yet. Try again.";
  }
  if (token == "progress") {
    re.innerHTML = "Incorrect, a Progress is someone who is just watching from a distance. Try again.";
  }
  if (token == "phexter") {
    if (attempts == 0) {
      re.innerHTML = "Perfect! A Phexter is spot on!";
    }
    else {
      re.innerHTML = "Phexter is Correct! You may proceed.";
    }
    re.innerHTML += "<p><a href='white-rabbit.html?m=unlocked'>you may proceed to the game</a> or try the <a href='chapters.html'>city block visualizer</a></p>";

    if (!localStorage.completed) {
      ++nuggets;
      localStorage.nuggets = nuggets;
      localStorage.completed = true;
    }
  }
  ++attempts;
  ++spheres;
  localStorage.attempts = attempts;  
  localStorage.spheres = spheres;
  updateScore();
}

// -----------------------------------------------------------------------------------------------------------
// @fn updateScore
//
// tells the user how many nuggets and spheres they've collected
// -----------------------------------------------------------------------------------------------------------
function updateScore() {
  co.innerHTML = nuggets + " üêî " + spheres + " üìç";
}

var ai = 0.5;    // max impulse
var di = 0.1;    // drag

var minx = 5;    // minimum X for player
var maxx = 93;   // maximum x for player
var miny = 10;   // minimum y for player
var maxy = 90;   // maximum y for player
var ax = 0;      // acceleration X
var ay = 0;      // acceleration Y
var mx = 3.2;    // max velocity X
var my = 3.2;    // max velocity Y
var vx = 0;      // velocity X
var vy = 0;      // velocity Y
var px = 50;     // position X
var py = 50;     // position Y
var eax = 0.0;   // enemy acceleration X
var eay = 0.0;   // enemy acceleration Y
var evx = 0.5;   // enemy velocity X
var evy = 0;     // enemy velocity Y
var ex = 40;     // enemy position X
var ey = 40;     // enemy position Y
var epsilon = 0.01;
var clock = 60;

function playAudio(mp3) {
  if (soundEnabled) {
    mp3.play();
  }
}

// -----------------------------------------------------------------------------------------------------------
// @fn keypress
//
// event handler for key strokes - used to gather arrow key input for nova fox
//
// @param e  keyboard event to process
// -----------------------------------------------------------------------------------------------------------
function keypress(e) {
  if (e.isComposing) {
    return;
  }
  if (clock <= 0) {
    return;
  }
  var movementKey = false;
  if (e.key == 'ArrowLeft') {
    ax = -ai;
    movementKey = true;
  }
  if (e.key == 'ArrowRight') {
    ax = ai;
    movementKey = true;
  }
  if (e.key == 'ArrowUp') {
    ay = -ai;
    movementKey = true;
  }
  if (e.key == 'ArrowDown') {
    ay = ai;
    movementKey = true;
  }
  gameLog += "\nkp {key: " + e.key + "};";
  if (movementKey) {
    playAudio(action);
  }
}

var soundEnabled = !(localStorage.soundEnabled == 'false');
var doubleTap = new Audio('double-tap.mp3');
var action = new Audio('action.mp3');
var warp = new Audio('warp.mp3');
doubleTap.volume = 0.2;
action.volume = 0.1;
warp.volume = 0.1;

// -----------------------------------------------------------------------------------------------------------
// @fn screenClick
//
// mouse click event handler for nova fox
//
// @param e  mouse event to process
// -----------------------------------------------------------------------------------------------------------
function screenClick(e) {
  if (clock <= 0) {
    return;
  }
  const topLeft = dgid("cell1_1").getBoundingClientRect();
  const bottomRight = dgid("cell64_16").getBoundingClientRect();
  const scWidth = (bottomRight.x - topLeft.x);
  const scHeight = (bottomRight.y - topLeft.y);
  const scX = 100*(e.x/scWidth - 0.1);
  const scY = 100*(e.y/scHeight - 0.2);

  const deltaX = scX - px;
  const deltaY = scY - py;
  vx += deltaX / 24;
  vy += deltaY / 24;
  gameLog += "\nmc {x:" + e.x + ", y:" + e.y + "};";
  playAudio(warp);
}

// -----------------------------------------------------------------------------------------------------------
// @fn render
//
// generates the main entry point for the white rabbit
// -----------------------------------------------------------------------------------------------------------
var questText = "";
function render() {
  loadVars();
  updateScore();
  
  var urlSearchParams = new URLSearchParams(window.location.search);
  var params = Object.fromEntries(urlSearchParams.entries());

  if (params.m && params.m == 'unlocked') {
    
    questText = startGame();

  } else {
    questText  = "<p<strong>level 0:</strong><br />";
    questText += "which <strong>term</strong> accurately describes someone who studies knowledge via phext?</p>";
    questText += "<input type='button' value='phexter' onclick='begin(\"phexter\");' />";
    questText += "<input type='button' value='lurker' onclick='begin(\"lurker\");' />";
    questText += "<input type='button' value='cortical' onclick='begin(\"cortical\");' />";
    questText += "<input type='button' value='progress' onclick='begin(\"progress\");' />";
    questText += "<p>Answer: <span id='response'></span></p>";
  }
  qb.innerHTML = questText;

  loadVarsForNovaFox();
  setSoundEnabledVisualState();
}

var elFudge = 0;
// -----------------------------------------------------------------------------------------------------------
// @fn expandLoader
//
// Translates hex digits to a rotating visualization, meant for testing mostly. Will be replaced by phorge.
// this method has side effects dominated by `elFudge` intentionally.
//
// @param c  hex digit to translate
// -----------------------------------------------------------------------------------------------------------
function expandLoader(c) {
  const hex = "0123456789abcdef";
  var value = (parseInt(c, 16) + elFudge) % 10;
  const lookup = "=A        ";
  ++elFudge;
  return lookup.charAt(value);
}

// -----------------------------------------------------------------------------------------------------------
// @fn loadLevel
//
// Loads the given level (or accepts one passed via the query string using the 'game' key).
//
// @param level  the game level to load
// -----------------------------------------------------------------------------------------------------------
function loadLevel(level) {
  var data = levels[level];

  var urlSearchParams = new URLSearchParams(window.location.search);
  var params = Object.fromEntries(urlSearchParams.entries());

  if (params.game) {
    var lines = 0;
    data = "";

    while (lines < 16) {
      for (var i = 0; i < 64; ++i) {
        data += expandLoader(params.game.charAt(i));
      }
      data += "\n";
      ++lines;
    }
  }

  var parts = data.split("\n");
  var output = "";
  var geometry1 = "ABCDEFGHIJKLMNOPQRSTUVWXYZ01234";
  var geometry2 = "abcdefghijklmnopqrstuvwxyz56789";

  var style1 = 'wall';
  var style2 = 'wall2';

  for (var j = 0; j < TILES_MAX_HEIGHT; ++j)
  {
    for (var i = 0; i < TILES_MAX_WIDTH; ++i)
    {
      var source = parts[j].charAt(i);
      var cell = source;
      var cellID = "cell" + (i+1) + "_" + (j+1);
      cell = cell.replaceAll(geometry1.charAt(source), "_;_");
      cell = cell.replaceAll(geometry2.charAt(source), "_;;_");
      cell = cell.replaceAll(" ", "_;;;_");
      cell = cell.replaceAll("=", "-;;-<div class='" + style1 + "'><div id='" + cellID + "' class='inner'></div></div>");
      cell = cell.replaceAll("_;_", "\n<div class='" + style2 + "'><div id='" + cellID + "' class='inner'></div></div>");
      cell = cell.replaceAll("_;;_", "\n<div class='" + style2 + "'><div id='" + cellID + "' class='inner'></div></div>");
      cell = cell.replaceAll("_;;;_", "\n<div class='floor'><div id='" + cellID + "' class='inner'></div></div>");
      cell = cell.replaceAll("-;;-", "\n");
      output += cell;
    }
    output += "<br style='clear:both;' />";    
  }
  
  return output;
}

// -----------------------------------------------------------------------------------------------------------
// @fn prevGame
//
// Event handler for the 'prev game' action. Decrements `gameLevel`, then re-renders nova fox.
// -----------------------------------------------------------------------------------------------------------
var gameLevel = 1;
function prevGame() {
  --gameLevel;
  if (gameLevel < 1) { gameLevel = 1; }
  render();
}

// -----------------------------------------------------------------------------------------------------------
// @fn nextGame
//
// Event handler for the 'next game' action. Increments `gameLevel` and re-renders nova fox.
// -----------------------------------------------------------------------------------------------------------
function nextGame() {
  ++gameLevel;
  if (gameLevel > 42) { gameLevel = 42; }
  render();
}

// -----------------------------------------------------------------------------------------------------------
// @fn screenToCell
//
// Converts the logical coordinates and neighbor indicator to a specific cell element.
// -----------------------------------------------------------------------------------------------------------
function screenToCell(x, y, neighbor) {
  var coords = coordinatesToIndex(x, y);
  if (neighbor == 'n')  { --coords.y; }
  if (neighbor == 'e')  { ++coords.x; }
  if (neighbor == 's')  { ++coords.y; }
  if (neighbor == 'w')  { --coords.x; }
  if (neighbor == 'ne') { --coords.y; ++coords.x; }
  if (neighbor == 'se') { ++coords.y; ++coords.x; }
  if (neighbor == 'sw') { ++coords.y; --coords.x; }
  if (neighbor == 'nw') { --coords.y; --coords.x; }
  if (coords.x < 1)  { coords.x = 1;  }
  if (coords.x > TILES_MAX_WIDTH) { coords.x = TILES_MAX_WIDTH; }
  if (coords.y < 1)  { coords.y = 1;  }
  if (coords.y > TILES_MAX_HEIGHT) { coords.y = TILES_MAX_HEIGHT; }
  return coordsToCell(coords.x, coords.y);
}

// -----------------------------------------------------------------------------------------------------------
// @fn coordsToCell
//
// Selects the given cell from our 64x16 matrix.
//
// @param x  the column number (1-64)
// @param y  the row number (1-16)
// -----------------------------------------------------------------------------------------------------------
function coordsToCell(x, y) {
  return dgid("cell" + x + "_" + y);
}

// -----------------------------------------------------------------------------------------------------------
// @fn coordinatesToIndex
//
// Fuzzy conversion of a set of percentage coordinates to numeric indexes. Over-samples a bit.
//
// @param x  a number in the range [5-95] to be converted to a column index
// @param y  a number in the range [5-95] to be converted to a row index
//
// @return a tuple containing x and y indexes into our matrix
// -----------------------------------------------------------------------------------------------------------
function coordinatesToIndex(x, y) {
  x = Math.round(x * 0.72, 0) - 2;
  y = Math.round(y * 0.2, 0);
  return {x: x, y: y};
}

// -----------------------------------------------------------------------------------------------------------
// @fn getShadowColor
//
// Calculates the shadow color for a given orbital and node.
//
// @param orbital  a designation indicating which orbit type to select
// @param vx       x velocity to modulate the output with
// @param vy       y velocity to modulate the output with
//
// @return a color representing the risk/reward of traveling through a cell
// -----------------------------------------------------------------------------------------------------------
function getShadowColor(orbital, vx, vy) {
  // red green blue
  var red = "74";
  var green = "82";
  var blue = "72";
  const magnitude = 1.6;
  if (vx < -magnitude) { red   = "42"; }
  if (vx >  magnitude) { red   = "e9"; }
  if (vy < -magnitude) { green = "88"; }
  if (vy >  magnitude) { green = "c6"; }
  var velocity = Math.sqrt(vx*vx+vy*vy);
  if (velocity < -magnitude) { blue = "40"; }
  if (velocity >  magnitude) { blue = "bf"; }
  if (orbital == 'nw' || orbital == 'ne' || orbital == 'sw' || orbital == 'se') {
    return "#" + red + "42" + blue;
  }
  if (orbital == 'w' || orbital == 'n' || orbital == 's' || orbital == 'e') {
    return "#64" + green + blue;
  }
  return "#3a3a" + blue;
}

var lastCell = false;
var enemyCell = false;
var orbitals = Array(
  'nw', 'n', 'ne',
  'w',  '',   'e',
  'sw', 's', 'se'
);

// -----------------------------------------------------------------------------------------------------------
// @fn timingLoop
//
// Applies physics calculations for our player - velocity and position mostly. Invokes itself every 100ms
// until the clock runs out.
// -----------------------------------------------------------------------------------------------------------
function timingLoop() {
  var velocity = Math.sqrt(vx*vx + vy*vy);
  gt.innerHTML = Math.round(clock) + " v: " + velocity.toFixed(2);
  gs.innerHTML = getGameScore();
  gameLog += "\ntl {ax: " + ax + ", ay: " + ay + ", vx: " + vx + ", vy: " + vy + ", px: " + px + ", py: " + py + "};";

  evx += (Math.random() - 0.5)/2;
  evy += (Math.random() - 0.5)/2;

  if (evy < -my) { evy = -my; }
  if (evy > my)  { evy = my;  }
  if (evx < -mx) { evx = -mx; }
  if (evx > mx)  { evx = mx;  }

  evx -= vy;
  evy -= vx;

  if (ex < 30) { evx += mx; }
  if (ex > 70) { evx -= mx; }
  if (ey < 20) { evy += my; }
  if (ey > 80) { evy -= my; }

  if (ax > epsilon)  { ax -= di; }
  if (ax < -epsilon) { ax += di; }
  if (ay > epsilon)  { ay -= di; }
  if (ay < -epsilon) { ay += di; }
  if (vx > epsilon)  { vx -= di; }
  if (vx < -epsilon) { vx += di; }
  if (vy > epsilon)  { vy -= di; }
  if (vy < -epsilon) { vy += di; }

  vx += ax;
  vy += ay;

  if (vx > mx)  { vx = mx;  }    if (evx > mx)  { evx = mx;  }
  if (vx < -mx) { vx = -mx; }    if (evx < -mx) { evx = -mx; }
  if (vy > my)  { vy = my;  }    if (evy > my)  { evy = my;  }
  if (vy < -my) { vy = -my; }    if (evy < -my) { evy = -my; }

  px += vx;  ex += evx;
  py += vy;  ey += evy;

  if (px < minx) { px = minx; }   if (ex < minx) { ex = minx; }
  if (px > maxx) { px = maxx; }   if (ex > maxx) { ex = maxx; }
  if (py < miny) { py = miny; }   if (ey < miny) { ey = miny; }
  if (py > maxy) { py = maxy; }   if (ey > maxy) { ey = maxy; }

  player.style.top  = py + "%";
  player.style.left = px + "%";
  enemy.style.top   = ey + "%";
  enemy.style.left  = ex + "%";

  for (var o = 0; o < orbitals.length; ++o) {
    var cell = screenToCell(px, py, orbitals[o]);
    var enemyCell = screenToCell(ex, ey, orbitals[o]);
    if (cell) {
      cell.style.backgroundColor = getShadowColor(orbitals[o], vx, vy);
      cell.style.border = '1px solid white';      
      lastCell = cell;
      setTimeout(() => {
        if (lastCell != cell && enemyCell != cell && cell) {
          cell.style.backgroundColor = '';
        }    
      }, 200);

      if (enemyCell && enemyCell.style.backgroundColor != '') {
        enemyCell.style.backgroundColor = '';
        enemyCell.style.border = '';
        baseScore += 10;
        playAudio(warp);
      }
    }
  }
  
  clock -= 0.1;
  if (clock > 0.4) {
    setTimeout(timingLoop, 100);
  } else {
    gameOver();
  }
}

// -----------------------------------------------------------------------------------------------------------
// @fn getGameScore
//
// Produces a point in time estimate of the score based upon the current game state.
// -----------------------------------------------------------------------------------------------------------
var baseScore = 0;
function getGameScore() {
  var score = baseScore;
  for (var i = 1; i < TILES_MAX_WIDTH; ++i) {
    for (var j = 1; j < TILES_MAX_HEIGHT; ++j) {
      var cell = coordsToCell(i, j);
      if (cell) {
        const test = cell.style.backgroundColor;
        if (test == 'grey') {
          score += 10;
        }
        if (test.match("114") != null) {
          score += 77;
        }
        if (test.match("116") != null) {
          score += 55;
        }
        if (test.match("130") != null) {
          score += 33;
        }
        if (test.length > 0) {
          score += 3;
        }
      }
    }
  }

  return score;
}

// -----------------------------------------------------------------------------------------------------------
// @fn gameOver
//
// Renders the final score board.
// -----------------------------------------------------------------------------------------------------------
function gameOver() {
  go.style.display = 'block';
  var score = getGameScore().toLocaleString();

  digestGame().then((gameHash) => {
    playAudio(doubleTap);
    const displayHash = gameHash.replace(/(.{16})/g, "$1\n");
    console.log("Game Hash: " + displayHash);
    go.innerHTML = "<h1>Game Over</h1><p>Score: " + score + "</p><p><a href='white-rabbit.html?m=unlocked&game=" + gameHash + "'>Next Level</a></p>";
    }
  );
}

// -----------------------------------------------------------------------------------------------------------
// @fn digestGame
//
// Computes a SHA-512 hash of the gameplay log.
// -----------------------------------------------------------------------------------------------------------
async function digestGame() {
  const buffer = new TextEncoder().encode(gameLog);
  const hashBuffer = await crypto.subtle.digest("SHA-512", buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
}

// -----------------------------------------------------------------------------------------------------------
// @fn toggleSound
//
// Toggles sound on or off depending upon the initial state, which is persisted locally.
// -----------------------------------------------------------------------------------------------------------
function toggleSound() {
  soundEnabled = !soundEnabled;
  setSoundEnabledVisualState();
  localStorage.soundEnabled = soundEnabled;  
}

// -----------------------------------------------------------------------------------------------------------
// @fn setSoundEnabledVisualState
//
// Renders the current sound state in the GUI.
// -----------------------------------------------------------------------------------------------------------
function setSoundEnabledVisualState() {
  sc.innerHTML = soundEnabled ? "ON" : "OFF";
}

// -----------------------------------------------------------------------------------------------------------
// @fn startGame
//
// Kickstarts nova fox!
// -----------------------------------------------------------------------------------------------------------
function startGame() {
  setTimeout(timingLoop, 100);
  dgid("intro").innerHTML = "";
  qb.style.width = "100%";

  var data = loadLevel(gameLevel);

  var levelDisplay = gameLevel;
  if (coordinate[gameLevel]) {
    levelDisplay = coordinate[gameLevel];
  }
  var board = `
  
  <div id="title">Nova Fox</div>
  <div id="screen" onclick="screenClick(event);">
    <div id="gameOver"></div>
    <div id="top">
      <div id="scoreLabel">score:</div><div id="gamescore">0</div>
      <div id="livesLabel">lives:</div><div id="gamelives">3</div>
      <div id="soundLabel">sound:</div><div id="soundControl" onclick="toggleSound();">ON</div>
      <div id="timer">1,000,000</div><div id="timerLabel">time:</div>
    </div>
    <div id="player"></div>
    <div id="enemy"></div>
    <div id="board">
    ` + data + `
    </div>
    <div id="bottom">
      <input type="button" id="prev" onclick="prevGame();" value="Prev" />
      <input type="button" id="select" value="Select ` + levelDisplay + `" />
      <input type="button" id="next" onclick="nextGame();" value="Next" />
    </div>
  </div>

  `.trim();

  return board;
}
</script>
</head>
<body onload="render();" onkeydown="keypress(event);">

<div id="banner">
  <div id="score">
    <div id="coins"></div>
  </div>
</div>

<div id="rabbit">
  <p id="intro">
  hi, i am üêá answer my query for a neural nugget üêî!<br />
  </p>

  <div id="breadcrumbs"><a href="index.html">Back to phext.io</a></div>
  <div id="questbox"></div>
</div>

<!--

Base 88

The 39 following characters are ommitted to streamline parsing and avoid the need for escape characters.

0x00 - 0x1f
0x22 '"'
0x27 '\''
0x3b ';'
0x3c '<'
0x3e '>'
0x5c '\'
0x60 '`'

Level Editor Symbols (Printable ASCII)
--------------------------------------
The lookup table below explains the meaning of each geometry tile.
You can use these glyphs to quickly type out your level in text.

We use Base-88 to encode all geometry and cartridges in nova fox levels (1 KB uncompressed text per room).
This spec defines the available geometry definitions that you can place in the level editor (i.e. your favorite text editor!).
nova fox makes use of generative geometry where neighboring cells fill in the blanks as it were.

Gameplay (2)
------------
'?' = save
'/' = spawn

Portals (9)
-----------
Just like in phext documents, there are 9 portal types in nova fox.

'_' = portal (red)     [scroll]
'&' = portal (green)   [section]
'@' = portal (blue)    [chapter]
'{' = portal (cyan)    [book]
'}' = portal (magenta) [volume]
'|' = portal (yellow)  [collection]
'[' = portal (white)   [shelf]
']' = portal (black)   [series]
'^' = jump gate (void) [library break]

Stuff (6)
---------
'(' = shield
')' = tool
'*' = powerup
'+' = life
',' = armor
'-' = weapon

Land (5)
--------
'=' = earth
'~' = water
' ' = air
'.' = lava
':' = path

Interaction (4)
---------------
'!' = clue
'#' = guide
'$' = treasure
'%' = chance

Flux (62)
---------
We don't know what these do, but they contribute entropy from the vaccuum. These tokens appear in a pseudo random fashion on each level. They are essentially background noise.

Most rooms are full of essentially incompressible noise like this:

riZX9UPR5V3DQif6a0TnpGxStT37jihxROaSuAwBb9rdCOJNuPxlhDJof1tDxub0
VHkVYAX0wEOAeLbyI7wNC153wR5cwnimrFYj6b8YnYSshm1Yk9PgpmLLz4rjZEeh
Ex5qMM8NqOEsF2upo52b9ivQed3ua0zSr2zBaseWrL8194qRnUcc2Q0aJXFy0PKC
GZtqddzsVj8F8ujkjNUQGWbl9LeU3RHnLcREf8uRzK2iIT2xHmLMbY5djJVaAfeD
pRrjkSl2MQnq3YQxpX3UMnJj1mlcqrdGM936zT99dZ6MwlYTdz870Su9QnU8rzR2
pI95hSikNg8b6ZR7hv5tJ3Z9kqchGT2iicis9JItq3FCMY9RZ42Omgt96aSn4fWt
F4c3riLj4Bs0e8zVWUCuIuZJ79Nd7r3qdwdTfHkPovRA4JkVnQss2RDH9SBjNA2k
ORG7uiV9udWsejVz984qEIxxRk1StQFVQwB1m3BegQtlV4FQBxYC1vUSfNNXZNIL
98Cn4cDEWrFpeAqIRPYUnbgAmQUJozmy6C1NSt3kHvAhefHWJ6VBZUqGr0pdI8Wa
xnorj7RIb6g2Z3h4i1LPIOGMotuI2rjp4dMDm9hKDFnSrvHdfIVJqqg5cexErxdw
iT6KrbgBXZlrFwDq1BaXzeTvsVDBaWOGBlCUeEJsM2kbjR3r2uStxNRHSdwkixAY
c1S5WBGzvVguMoOLi5IaIUrjCznrt3H2l9baOPfkaxHoJexxEHG6ghRCkWuqrTQO
ndXaaEonehbQyNo8mPDNAAzJsgatREe2xnHpwH1Dtn19ZXv4QI7eEmKndRs3b28w
FJBhF5H7jUHHyUmlIo61mr348m4JzZHHAnZbk6eOwkfPqWPQTaKjwNwCiDZY5iiS
Q3MdirMkRvKdk9adW9HHcOtJdy3zM4oFEPFyXqjbsVWc4b9UsjS0lTnmfVqurf9R
1CuujPJ6OlDGvr7gI2Rqzdjr4fJFIgh27V1lTEtEw2CKtW64QRKe1VVMtDsCKFIt

-->

<script type="text/javascript">
var levels = Array();
var coordinate = Array();
var carts = Array();
coordinate[1] = "1.1.1/1.1.1/1.1.1";
levels[1] = `
================= =========================== ==================
=                                                    =        ==
=                                                    =        ==
     =====     =     =   =======   =     =   =======           
     =     =   =     =   =          =   =       =              
     =     =   =     =   =           = =        =              
     =====     =======   =====        =         =              
     =         =     =   =           = =        =              
     =         =     =   =          =   =       =              
     =         =     =   =======   =     =      =              
=                                                    =        ==
=                                                    =        ==
                                                     =         
=                                                             ==
=                                                             ==
=================== ========================= ==================
`;
carts[1] = `

`;
coordinate[2] = "1.1.1/1.1.1/1.1.2"; levels[2] = `
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
================================================================
`;
coordinate[3] = "42.42.42/42.42.42/42.42.42"; levels[3] = `
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890=
================================================================
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890=
================================================================
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890=
================================================================
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890=
================================================================
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890=
================================================================
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890=
================================================================
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ012345678901
================================================================
abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ012345678901
================================================================
`;
coordinate[4] = "1.2.3/4.5.6/7.8.9";
levels[4] = `
riZX9UPR5V3DQif6a0TnpGxStT37jihxROaSuAwBb9rdCOJNuPxlhDJof1tDxub0
VHkVYAX0wEOAeLbyI7wNC153wR5cwnimrFYj6b8YnYSshm1Yk9PgpmLLz4rjZEeh
Ex5qMM8NqOEsF2upo52b9ivQed3ua0zSr2zBaseWrL8194qRnUcc2Q0aJXFy0PKC
GZtqddzsVj8F8ujkjNUQGWbl9LeU3RHnLcREf8uRzK2iIT2xHmLMbY5djJVaAfeD
pRrjkSl2MQnq3YQxpX3UMnJj1mlcqrdGM936zT99dZ6MwlYTdz870Su9QnU8rzR2
pI95hSikNg8b6ZR7hv5tJ3Z9kqchGT2iicis9JItq3FCMY9RZ42Omgt96aSn4fWt
F4c3riLj4Bs0e8zVWUCuIuZJ79Nd7r3qdwdTfHkPovRA4JkVnQss2RDH9SBjNA2k
ORG7uiV9udWsejVz984qEIxxRk1StQFVQwB1m3BegQtlV4FQBxYC1vUSfNNXZNIL
98Cn4cDEWrFpeAqIRPYUnbgAmQUJozmy6C1NSt3kHvAhefHWJ6VBZUqGr0pdI8Wa
xnorj7RIb6g2Z3h4i1LPIOGMotuI2rjp4dMDm9hKDFnSrvHdfIVJqqg5cexErxdw
iT6KrbgBXZlrFwDq1BaXzeTvsVDBaWOGBlCUeEJsM2kbjR3r2uStxNRHSdwkixAY
c1S5WBGzvVguMoOLi5IaIUrjCznrt3H2l9baOPfkaxHoJexxEHG6ghRCkWuqrTQO
ndXaaEonehbQyNo8mPDNAAzJsgatREe2xnHpwH1Dtn19ZXv4QI7eEmKndRs3b28w
FJBhF5H7jUHHyUmlIo61mr348m4JzZHHAnZbk6eOwkfPqWPQTaKjwNwCiDZY5iiS
Q3MdirMkRvKdk9adW9HHcOtJdy3zM4oFEPFyXqjbsVWc4b9UsjS0lTnmfVqurf9R
1CuujPJ6OlDGvr7gI2Rqzdjr4fJFIgh27V1lTEtEw2CKtW64QRKe1VVMtDsCKFIt
`;
coordinate[5] = "1.4.4/2.8.8/4.16.16";
levels[5] = `
r===9UPR5V3DQif6a0TnpGxStT37jihxROaSuAw==9rdCOJNuPxlhDJof1t===b0
VHkVYAX====AeLbyI7wNC153wR5cwnimrFYj===YnYSshm1Yk9PgpmLLz4rjZEeh
Ex5qMM8NqOEsF2upo52b9ivQed3ua0z===zBaseWrL8194qRnUcc2Q0aJXFy0PKC
GZtqddzsVj8=8ujkjNUQGWbl9LeU3RHnLc==f8uRzK2iIT2xHmLMbY5dj==aAf=D
pRrjkSl2MQnq3YQxpX3UMnJj1mlcqr=GM936zT99dZ6MwlYTdz870Su9QnU8rzR2
pI95hSikNg8b=ZR7hv5tJ3Z9kqch==2iicis9JItq3FCMY9RZ42Omgt96aSn4fW=
F4c3riLj4Bs0e8zVWUCuIuZJ7===7r3qdwdTfHkPovRA4JkVnQss2RD==SBjNA2=
ORG7uiV9udWse=Vz984qEIx==k1StQFVQwB1m3BegQtlV4FQBxYC1vUSfNNXZNI=
98Cn4cDEWrFpeAqIRPYUnb=AmQUJozmy6C1NSt3kHvAhefHWJ6VBZUqGr0pdI8W=
xnorj7RIb6g2Z3h4i1LP=OGMotuI2rjp4dMDm9hKD====vHdfIVJqqg5cexErxd=
iT6KrbgBXZlrFw=q1BaXz=TvsVDBaWOGBlCUeEJsM2kbj==r2uStxNRHSdwkixA=
c1S5WBGzvVguMoOLi5I=IUrjCznrt3H2l9baOPfkaxHoJex==HG6g==RCkWuqr=O
ndXaaEonehbQyNo===DNAAzJsgatREe2xnHpwH1Dtn19ZXv4QI7eEmKndRs3b2=w
FJBhF5H7jUHHyUmlIo=1mr348m4JzZHHAnZbk6eOwkfPqWPQT==jwNwCiDZY5i=S
Q3MdirMkRvKdk9adW9HHcOtJdy3zM4oFEPFyXqjbsVWc4b9UsjS==TnmfVqurf=R
1CuujPJ6OlDGvr7gI2Rqzdjr4fJFIgh27V1lTEtEw2CKtW64QRKe1VVMtDsCKF=t
`;
levels[6] = ``;
levels[7] = ``;
levels[8] = ``;
levels[9] = ``;
levels[10] = ``;
levels[11] = ``;
levels[12] = ``;
levels[13] = ``;
levels[14] = ``;
levels[15] = ``;
levels[16] = ``;
levels[17] = ``;
levels[18] = ``;
levels[19] = ``;
levels[20] = ``;
levels[21] = ``;
levels[22] = ``;
levels[23] = ``;
levels[24] = ``;
levels[25] = ``;
levels[26] = ``;
levels[27] = ``;
levels[28] = ``;
levels[29] = ``;
levels[30] = ``;
levels[31] = ``;
levels[32] = ``;
levels[33] = ``;
levels[34] = ``;
levels[35] = ``;
levels[36] = ``;
levels[37] = ``;
levels[38] = ``;
levels[39] = ``;
levels[40] = ``;
levels[41] = ``;
levels[42] = ``;

carts[2] = ``;
carts[3] = ``;
carts[4] = ``;
carts[5] = ``;
carts[6] = ``;
carts[7] = ``;
carts[8] = ``;
carts[9] = ``;
carts[10] = ``;
carts[11] = ``;
carts[12] = ``;
carts[13] = ``;
carts[14] = ``;
carts[15] = ``;
carts[16] = ``;
carts[17] = ``;
carts[18] = ``;
carts[19] = ``;
carts[20] = ``;
carts[21] = ``;
carts[22] = ``;
carts[23] = ``;
carts[24] = ``;
carts[25] = ``;
carts[26] = ``;
carts[27] = ``;
carts[28] = ``;
carts[29] = ``;
carts[30] = ``;
carts[31] = ``;
carts[32] = ``;
carts[33] = ``;
carts[34] = ``;
carts[35] = ``;
carts[36] = ``;
carts[37] = ``;
carts[38] = ``;
carts[39] = ``;
carts[40] = ``;
carts[41] = ``;
carts[42] = ``;

for (var i = 1; i <= 42; ++i) {
  if (coordinate[i]) {
    coordinate[i] = coordinate[i].trim();
  }
  if (levels[i]) {
    levels[i] = levels[i].trim();
  }
  if (carts[i]) {
    carts[i] = carts[i].trim();
  }
}
</script>

</body>
</html>